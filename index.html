<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🔥 Viral Hook Generator — 15s TTS</title>
  <meta name="description" content="Generate VO (4 kalimat ~15 detik) + Caption & Hashtag dengan berbagai formula viral." />
  <style>
    * { box-sizing: border-box; }
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(160deg, #0b1020, #0a0f1e 40%, #0b1226);
      color: var(--text);
      min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:32px;
    }
    .app { width:100%; max-width: 860px; }
    .header {
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:20px;
    }
    h1 { font-size: clamp(22px, 2.4vw, 28px); margin:0; letter-spacing: .3px; }
    .badge { font-size:12px; color:#a3e635; background:#052e16; border:1px solid #14532d; padding:4px 8px; border-radius:999px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(148,163,184,.15);
      border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row { display:flex; gap:10px; align-items:center; }
    input[type="text"] {
      flex:1;
      background: #0b1220; color: var(--text);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 10px; padding: 12px 14px; font-size: 15px;
      outline: none;
    }
    button {
      background: #10b981; color:#00100a; font-weight:700;
      border: none; border-radius: 10px; padding: 12px 16px; font-size: 15px; cursor: pointer;
      box-shadow: 0 6px 20px rgba(16,185,129,.25);
      transition: opacity .2s ease;
    }
    button.secondary { background: #1f2937; color:#e5e7eb; box-shadow: none; border:1px solid rgba(148,163,184,.2); }
    button.ghost {
      background: transparent; color: #cbd5e1; border:1px dashed rgba(148,163,184,.35);
      padding: 10px 12px; font-weight:600; border-radius: 10px;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; box-shadow: none; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; margin-top:14px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    .box h3 { margin:6px 0 10px 0; font-size: 14px; color: var(--muted); letter-spacing:.3px; }
    textarea {
      width:100%; height: 180px; background:#020617; color:var(--text);
      border:1px solid rgba(148,163,184,.15); border-radius:12px; padding:12px; resize: vertical; font-size:14px; line-height:1.5;
    }
    .actions { display:flex; gap:8px; margin-top:8px; }
    .hint { margin-top: 10px; font-size: 12px; color: var(--muted); }
    .footer { margin-top: 16px; display:flex; justify-content: space-between; align-items:center; color: var(--muted); font-size:12px; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-top-color:#22c55e; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-3px; margin-right:6px; }
    @keyframes spin { to{ transform:rotate(360deg); } }

    select {
      background: #0b1220;
      color: var(--text);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 15px;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor:pointer;
      min-width: 160px;
    }
    .row > div { flex: 0 0 auto; }

    /* Responsive */
    @media (max-width: 600px) {
      .row { flex-wrap: wrap; }
      .row input[type="text"], .row select, .row button {
        width: 100%; min-width: unset; margin-bottom: 8px;
      }
      .row > div { flex: 1; width: 100%; min-width: unset; margin-bottom: 8px; }
      .row button { margin-top: 2px; }
    }

    .formula-mobile { display: none; }
    @media (max-width: 600px) {
      .header { flex-direction: column; align-items: flex-start; gap: 5px; }
      .formula-desktop { display: none; }
      .formula-mobile { display: block; font-size:12px; color:var(--muted); }
      .header h1 { font-size: 24px; }
    }

    /* Status hidden by default */
    #status { display:none; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>🔥 Viral Hook Generator <span class="badge">15s TTS</span></h1>
      <div class="formula-desktop" style="font-size:12px;color:#9ca3af">
        Pilih formula: ACTA • HALUS(VSOFT) • VIBE • HABIT • RELATE • MINOR • HACK
      </div>
      <div class="formula-mobile">Formula: ACTA / HALUS / VIBE / HABIT / RELATE / MINOR / HACK</div>
    </div>

    <div class="card">
      <div class="row">
        <input id="product" type="text" placeholder="Masukkan produk… (contoh: Sepatu Cowok)" />
        <div class="row" style="gap:8px">
          <select id="styleSelector" title="Pilih formula">
            <option value="acta">🔥 ACTA (Viral)</option>
            <option value="halus">✨ HALUS (VSOFT)</option>
            <option value="genz">😎 VIBE (Gen Z)</option>
            <option value="habit">☕ HABIT (Rutinitas)</option>
            <option value="relate">🤝 RELATE (Cuma Aku/Kalian Juga?)</option>
            <option value="minor">😅 MINOR (Sepele Tapi Nyebelin)</option>
            <option value="hack">🛠️ HACK (Life Hack)</option>
          </select>
          <button id="clearHistoryBtn" class="ghost" title="Reset riwayat opener untuk formula terpilih (anti-ulang dimulai dari nol)">Clear History</button>
        </div>
        <button id="genBtn" title="Generate VO & Caption (cooldown 3 detik)">Generate</button>
        <button id="clearBtn" class="secondary" title="Bersihkan input & hasil di layar (riwayat opener tetap tersimpan)">Clear</button>
      </div>

      <div class="grid">
        <div class="box">
          <h3>🔊 Voice Over (4 kalimat • ±15 detik)</h3>
          <textarea id="vo" readonly placeholder="Hasil VO akan muncul di sini…"></textarea>
          <div class="actions">
            <button id="copyVo" title="Salin VO ke clipboard">Copy VO</button>
            <button id="regenVo" class="secondary" title="Regenerate VO saja (cooldown 3 detik)">Regenerate VO</button>
          </div>
          <div class="hint">Tip: paste ke TTS, atur speed ±1.0 untuk durasi ±15s.</div>
        </div>
        <div class="box">
          <h3>✍️ Caption & Hashtag</h3>
          <textarea id="caption" readonly placeholder="Hasil Caption & Hashtag akan muncul di sini…"></textarea>
          <div class="actions">
            <button id="copyCap" title="Salin Caption ke clipboard">Copy Caption</button>
            <button id="regenCap" class="secondary" title="Regenerate Caption saja (cooldown 3 detik)">Regenerate Caption</button>
          </div>
          <div class="hint">Format: 2–3 kalimat + 5 hashtag relevan.</div>
        </div>
      </div>

      <div class="footer">
        <div>© 2025 PakPeo — All Rights Reserved</div>
        <div id="status"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { lastProduct: "", lastVO: "", lastCaption: "" };
    let isBusy = false; // blokir aksi ganda selama proses

    /* ===== Persist pilihan formula ===== */
    const savedStyle = localStorage.getItem("vhg-style");
    if (savedStyle) {
      const sel = $("styleSelector");
      if ([...sel.options].some(o => o.value === savedStyle)) sel.value = savedStyle;
    }
    $("styleSelector").addEventListener("change", (e) => {
      localStorage.setItem("vhg-style", e.target.value);
    });

    /* ===== Anti-ulang opener berbasis riwayat (per-formula) ===== */
    const OPENERS_KEY = "vhg-openers";
    function getOpeners(style) {
      try { return JSON.parse(localStorage.getItem(`${OPENERS_KEY}:${style}`) || "[]"); }
      catch { return []; }
    }
    function extractOpener(voText) {
      if (!voText) return "";
      const firstSentence = voText.split(/[.!?]/)[0]; // kalimat pertama
      return firstSentence.trim().split(/\s+/).slice(0,4).join(" "); // 3–4 kata pertama
    }
    function pushOpener(style, voText) {
      const opener = extractOpener(voText);
      if (!opener) return;
      const list = getOpeners(style).filter(s => s.toLowerCase() !== opener.toLowerCase());
      list.unshift(opener);
      localStorage.setItem(`${OPENERS_KEY}:${style}`, JSON.stringify(list.slice(0,7))); // simpan max 7
    }
    function clearOpeners(style) {
      localStorage.removeItem(`${OPENERS_KEY}:${style}`);
      toast("Riwayat opener dibersihkan untuk formula ini.");
    }

    /* ===== Mini toast via status bar ===== */
    function toast(msg) {
      const status = $("status");
      status.style.display = "flex";
      status.innerHTML = msg;
      setTimeout(() => { status.style.display = "none"; status.textContent = ""; }, 1400);
    }

    /* ===== Cooldown helper (anti-spam) ===== */
    function cooldownButton(btn, ms = 3000) {
      btn.disabled = true;
      btn.setAttribute("aria-disabled", "true");
      setTimeout(() => {
        btn.disabled = false;
        btn.removeAttribute("aria-disabled");
      }, ms);
    }
    function lockUI() {
      isBusy = true;
      $("genBtn").disabled = true;
      $("regenVo").disabled = true;
      $("regenCap").disabled = true;
    }
    function unlockUI() {
      isBusy = false;
      $("genBtn").disabled = false;
      $("regenVo").disabled = false;
      $("regenCap").disabled = false;
    }

    async function callApi(route, payload) {
      const res = await fetch(route, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        let msg = res.statusText || ("HTTP Error " + res.status);
        try {
          const errJson = await res.json();
          if (errJson?.error) msg = errJson.error;
        } catch {}
        throw new Error(msg);
      }
      return res.json();
    }

    function setLoading(loading, target) {
      const status = $("status");
      if (loading) {
        status.style.display = "flex";
        status.innerHTML = '<span class="spinner"></span> Generating…';
        if (target) target.value = "⏳ Generating…";
        lockUI();
      } else {
        status.style.display = "none"; // auto-hide
        status.textContent = "";
        unlockUI();
      }
    }

    async function generateAll() {
      if (isBusy) return; // cegah double trigger
      const product = $("product").value.trim();
      if (!product) return alert("Isi nama produk dulu ya.");
      state.lastProduct = product;

      const style = $("styleSelector").value;
      const avoidOpeners = getOpeners(style);

      setLoading(true, $("vo"));
      $("caption").value = "⏳ Generating…";
      try {
        const data = await callApi("/.netlify/functions/generate", { product, mode: "both", style, avoidOpeners });
        $("vo").value = data.vo || "";
        $("caption").value = data.caption || "";
        state.lastVO = data.vo || "";
        state.lastCaption = data.caption || "";
        pushOpener(style, data.vo); // simpan opener terbaru
      } catch (e) {
        let msg = e.message || "Gagal generate.";
        if (/429/.test(msg)) msg = "Terlalu banyak permintaan (429). Coba lagi sebentar, ya.";
        alert("Gagal generate: " + msg);
      } finally {
        setLoading(false);
      }
    }

    async function regen(kind) {
      if (isBusy) return; // cegah double trigger
      const product = state.lastProduct || $("product").value.trim();
      if (!product) return alert("Isi nama produk dulu ya.");

      const style = $("styleSelector").value;
      const avoidOpeners = getOpeners(style);

      setLoading(true, kind === "vo" ? $("vo") : $("caption"));
      try {
        const data = await callApi("/.netlify/functions/generate", { product, mode: kind, style, avoidOpeners });
        if (kind === "vo") {
          $("vo").value = data.vo || "";
          state.lastVO = data.vo || "";
          pushOpener(style, data.vo);
        } else {
          $("caption").value = data.caption || "";
          state.lastCaption = data.caption || "";
        }
      } catch (e) {
        let msg = e.message || "Gagal regenerate.";
        if (/429/.test(msg)) msg = "Terlalu banyak permintaan (429). Coba lagi sebentar, ya.";
        alert("Gagal regenerate: " + msg);
      } finally {
        setLoading(false);
      }
    }

    function copyToClipboard(elId) {
      const el = $(elId);
      el.select();
      document.execCommand("copy");
      const btn = elId === "vo" ? $("copyVo") : $("copyCap");
      const prev = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(() => (btn.textContent = prev), 900);
    }

    // Event listeners + cooldown
    $("genBtn").addEventListener("click", () => { generateAll(); cooldownButton($("genBtn"), 3000); });
    $("clearBtn").addEventListener("click", () => { $("product").value=""; $("vo").value=""; $("caption").value=""; });
    $("regenVo").addEventListener("click", () => { regen("vo"); cooldownButton($("regenVo"), 3000); });
    $("regenCap").addEventListener("click", () => { regen("caption"); cooldownButton($("regenCap"), 3000); });
    $("copyVo").addEventListener("click", () => copyToClipboard("vo"));
    $("copyCap").addEventListener("click", () => copyToClipboard("caption"));
    $("clearHistoryBtn").addEventListener("click", () => clearOpeners($("styleSelector").value));

    // Enter to generate (ikutin cooldown juga)
    $("product").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !isBusy) {
        generateAll(); cooldownButton($("genBtn"), 3000);
      }
    });
  </script>
</body>
</html>
